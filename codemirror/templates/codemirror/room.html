<!doctype html>

{% load staticfiles %}


<html>
  <head>
    <title>Overkode</title>

    <link rel="stylesheet" href="{% static "lib/codemirror.css" %}"> 
    <script src="{% static "lib/codemirror.js" %}"></script>
    <script src="{% static "mode/xml/xml.js" %}"></script>
    <script src="{% static "mode/python/python.js" %}"></script>
    <link rel="stylesheet" href="{% static "doc/docs.css" %}">
   

    <style type="text/css">
      .codemirror {border-top: 1px solid black; border-bottom: 1px solid black;}
      .activeline {background: #e8f2ff !important;}
    </style>

  </head>
  <body>
    <h1>Overkode: codemirror + django channels 1</h1>

    <form><textarea id="code" name="code">
</textarea></form>
<script>

    // django lines
    // console.log("django LINES")

    var roomName = {{ room_name_json }};
    var user = getRandomInt(0,999)

    var codemirrorSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/codemirror/' + roomName + '/');

    codemirrorSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        set_data(data)

        // if (set_data(data)) {
        //     set_message(data)
        // }
    };


    function set_data(data) {
        
        console.log("check_receivers " + user)
        content = data['content']

        for (var row in content){

            from = {}
            from['line'] = row
            from['ch'] = content[row][0]

            to = {}
            to['line'] = row
            to['ch'] = content[row][1].length


            existing = editor.getRange(from, to)
            
            console.log("Comparamos")
            console.log(row+": "+existing+" == "+content[row][1])

            line = editor.getLine(row)
            
            console.log(line)

            // TODO: Hacer que escriba bien los saltos de linea
            if (existing != content[row][1] || line == "") {
                if (line == "") {
                    if (row == 0){
                        editor.setLine(row, line+"\n")
                    }
                    else{
                        editor.setLine((row-1), content[row-1][1]+"\n")
                    }

                } else {
                    editor.replaceRange(content[row][1], from, to)
                }
            }
            
        }

    };

    // function set_message(data) {
    //     console.log("Setting message CONTENT")

    //     content = data['content']

    //     console.log(content)
    //     for (var row in content){

    //         from = {}
    //         from['line'] = row
    //         from['ch'] = content[row][0]

    //         to = {}
    //         to['line'] = row
    //         to['ch'] = content[row][1].length

    //         // line = editor.getLineHandle(row)
    //         // console.log(line)

    //         // if (line == undefined) {
    //         //     editor.setLine(row, "")    
    //         // } else{
    //         // }
    //         if(to['ch'] > 0){
    //             editor.replaceRange(content[row][1], from, to)
    //         }

    //         // console.log("Escribimos")
    //         // console.log(row+": "+content[row][1])
    //     }
        
    //     return true;

    // };

    codemirrorSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    };

    document.querySelector('#code').focus();



    // codemirror lines
    // console.log("CodeMirror LINES");
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        // mode: "application/xml",
        mode: "python",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,

        onChange: function (cm, co) {
            
            codemirrorSocket.send(JSON.stringify( create_message(cm,co) ));
            
        },

    });

    function create_message(cm, co){
        
        // console.log(co)
        var from_line = co.from.line
        var from_char = co.from.ch
        var text = co.text
        var size = String(text).length
        var to_line = cm.getCursor().line+1
        var to_char = co.to.ch

        cm.setLineClass(hlLine, null);
        hlLine = cm.setLineClass(cm.getCursor().line, "activeline");

        var action = "Add"
        if (from_char < to_char) {
            action = "Del"
            var temp = from_char
            from_char = to_char
            to_char = temp
        } else if (from_char == to_char) {
            to_char = from_char + size
        }

        if(!hlLine.text){
            text = hlLine.text
        }


        // console.log(action+" char[" + size + "]: " + text);
        // console.log("on line (" + from_line +  ") from: " + from_char + " to: " + to_char);
        // console.log(get_lines(from_line, to_line));
        

        msg = {}

        creation = {}
        creation['timestamp'] = "now"
        creation['user'] = user
        creation['action'] = action

        rcv = {}
        rcv['id'] = user
        rcv['username'] = "Anonymous"
        // rcv['port'] = 
        
        msg['creation'] = creation
        msg['receivers'] = {}
        msg['receivers'][user] = rcv
        msg['content'] = get_lines(from_line, to_line)

        // console.log(msg)

        return msg
        // return hlLine.text
    };

    var hlLine = editor.setLineClass(0, "activeline");

    function get_lines(start, end){
        lines = {}
        for (var i = start; i < end; i++) {
            lines[i] = [0]
            lines[i].push(editor.getLineHandle(i).text)
        }
        console.log(lines)
        return lines
    }


</script>

  </body>
</html>













