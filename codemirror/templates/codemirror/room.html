<!doctype html>

{% load staticfiles %}


<html>
  <head>
    <title>Overkode</title>

    <link rel="stylesheet" href="{% static "lib/codemirror.css" %}"> 
    <script src="{% static "lib/codemirror.js" %}"></script>
    <script src="{% static "mode/xml/xml.js" %}"></script>
    <script src="{% static "mode/python/python.js" %}"></script>
    <link rel="stylesheet" href="{% static "doc/docs.css" %}">
   

    <style type="text/css">
      .codemirror {border-top: 1px solid black; border-bottom: 1px solid black;}
      .activeline {background: #e8f2ff !important;}
    </style>

  </head>
  <body>
    <h1>Overkode: codemirror + django channels 1</h1>

    <form><textarea id="code" name="code">
</textarea></form>
<script>

    // django lines
    // console.log("django LINES")

    var roomName = {{ room_name_json }};
    var user = getRandomInt(0,999)

    var codemirrorSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/codemirror/' + roomName + '/');

    codemirrorSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        rows = check_data(data)

        // if (rows.length > 0) {
        //     set_message(data, rows)
        // };
        console.log("------------------------------")
        console.log("")
        
    };

    codemirrorSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    };

    document.querySelector('#code').focus();



    // codemirror lines
    // console.log("CodeMirror LINES");
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        // mode: "application/xml",
        mode: "python",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,

        onChange: function (cm, co) {
            codemirrorSocket.send(JSON.stringify( create_message(cm,co) ));
        },

    });





// CHECK DATA
    function check_data(data) {

        // console.log("check_receivers " + user)
        content = data['content']
        action = data['creation']['action']
        console.log("Comparamos");

        console.log(content)
        // editor.replaceRange( content['text'] , content['from'], content['to'])

        set_lines = []
        for (var row in content){

            from = {}
            from['line'] = row
            from['ch'] = content[row]['ch']

            to = {}
            to['line'] = row
            to['ch'] = content[row]['text'].length


            existing = editor.getRange(from, to)
            

            // console.log(row+": "+existing+" == "+content[row]['text'])
            line = editor.getLine(row)
            // console.log(row + " - "+line)

            if (line == undefined) {
                set_lines.push(row)
            } else if (existing != content[row]['text']) {
                set_lines.push(row)
            }

        }

        return set_lines

    };



// SET MESSAGE
    function set_message(data, rows) {

        console.log("Setting message CONTENT")

        content = data['content']

        console.log(content)
        // console.log(rows)
        // console.log(rows.length)
        


        for (var index in rows){
            row = rows[index]

            console.log("["+index+"] row: "+row + " text: "+content[row]['text'])
            // console.log(editor.getLine(row))
            // TODO: Solucionar problema entre lineas del array y del editor

            from = {}
            from['line'] = row
            from['ch'] = content[row]['ch']

            to = {}
            to['line'] = row
            to['ch'] = content[row]['ch']

            row_text = content[row]['text']
            
            line = editor.getLine(row)
            if (line == undefined || row_text == "") {

                last_line = editor.getLine(row-1)
                editor.setLine(row-1, last_line+"\n")

                if (row_text != "") {
                    // console.log(row_text)
                    editor.replaceRange( row_text , from, to)
                };
                
            } else  {
                editor.replaceRange( row_text , from, to)
            }
        };
    };




// GET LINES
    function get_lines(start, end){

        // console.log("get lines")
        lines = {}
        for (var i = start; i <= end; i++) {
            lines[i] = {}
            lines[i]['ch'] = 0
            lines[i]['text'] = editor.getLine(i)

            // lines[i].push(editor.getLineHandle(i).text)
        }
        // console.log(lines)
        return lines
    }






// CREATE MESSAGE
    function create_message(cm, co){
        
        console.log(co)

        var from_line = co.from.line
        var from_char = co.from.ch
        var text = co.text
        var size = String(text).length
        var to_line = cm.getCursor().line
        var to_char = co.to.ch

        cm.setLineClass(hlLine, null);
        hlLine = cm.setLineClass(cm.getCursor().line, "activeline");

        var action = "Add"
        if (from_char < to_char) {
            action = "Del"
            var temp = from_char
            from_char = to_char
            to_char = temp
        } else if (from_char == to_char) {
            to_char = from_char + size
        }

        if (co.text.length > 1 && co.text[0] == co.text[1] && co.text[0] == ""){
            console.log("SALTO DE L√çNEA")
            console.log(co.text)
            action = "return"
        } 



        console.log(action+" char[" + size + "]: " + text);
        console.log("on line (" + from_line +  ") from: " + from_char + " to: " + to_char);


        msg = {}

        creation = {}
        creation['timestamp'] = "now"
        creation['user'] = user
        creation['action'] = action

        rcv = {}
        rcv['id'] = user
        rcv['username'] = "Anonymous"
        // rcv['port'] = 
        
        msg['creation'] = creation
        msg['receivers'] = {}
        msg['receivers'][user] = rcv

        msg['content'] = get_lines(from_line, to_line)
        // msg['content'] = co

        // console.log(msg)

        return msg
    };

    var hlLine = editor.setLineClass(0, "activeline");

    


</script>

  </body>
</html>













